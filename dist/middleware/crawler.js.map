{"version":3,"sources":["../../src/middleware/crawler.js"],"names":["pagesToVisit","changedPages","errorPages","brokenLinks","loopCount","requestCount","bandwidthUsed","PAGE_REG_EXP","TYPE_REG_EXP","checkUrls","req","res","next","pagesToCrawl","i","length","thisPage","url","test","status","continueLoop","thisPageToVisit","currentCount","setTimeout","requestPage","finishLoop","pageUrl","currentIndex","wasVisited","indexOf","error","response","body","headersMem","headers","bodyMem","date","Date","console","log","toTimeString","loopBack","redirects","request","_redirect","finalRedirect","finalDestination","statusCode","destIsInToVisit","findIndex","page","redirectStatus","pageObj","isInPagesToCrawl","isChanged","collectLinks","$","load","urlObj","domainBaseUrl","hostname","domainRegExp","RegExp","protocol","linkTagsObj","link","linkRef","attr","isAbsolute","revisedLinkRef","replace","linkUrl","linkObj","page_url","link_url","isCorrectLinkType","isCorrectPageType","isCorrectDomain","isInError","isInBroken","toVisitIndex","isInToVisit","revisedBandwidth","Math","round","toString","pagesCrawled"],"mappings":"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","file":"crawler.js","sourcesContent":["/* eslint no-loop-func: 0 */\n/* eslint no-nested-ternary: 0 */\n\nimport request from 'request';\nimport cheerio from 'cheerio';\nimport urlParse from 'url-parse';\nimport sizeof from 'object-sizeof';\n// import heapdump from 'heapdump';\n\n// Arrays for keeping track of page info as the crawler iterates through\n// pages\nlet pagesToVisit = [];\nlet changedPages = [];\nlet errorPages = [];\nlet brokenLinks = [];\nlet loopCount = 0;\nlet requestCount = 0;\nlet bandwidthUsed = 0;\n// RegExps to skip unimportant pages (PAGE_REG_EXP) and not to crawl non-html\n// pages for links (TYPE_REG_EXP), because that results in errors\nconst PAGE_REG_EXP = /permalink|visited-locations|transcripts|news/i;\nconst TYPE_REG_EXP = /\\.zip|\\.doc|\\.ppt|\\.csv|\\.xls|\\.jpg|\\.ash|\\.png|\\.aspx/i;\n\n// Starts the process by building the necessary page arrays\nfunction checkUrls(req, res, next) {\n  const {pagesToCrawl} = req;\n\n  // Loop through existing URLs pulled from Google Sheets,\n  // adding them to 'pagesToVisit' and 'errorPages' arrays\n  for (let i = 0; i < pagesToCrawl.length; i++) {\n    const thisPage = pagesToCrawl[i];\n\n    pagesToVisit[pagesToVisit.length] = thisPage.url;\n\n    if (/40\\d/.test(thisPage.status)) {\n      errorPages[errorPages.length] = thisPage.url;\n    }\n  }\n\n  continueLoop(req, res, next);\n}\n\nfunction continueLoop(req, res, next) {\n  if (loopCount < pagesToVisit.length) {\n    for (loopCount; loopCount < pagesToVisit.length; loopCount++) {\n      const thisPageToVisit = pagesToVisit[loopCount];\n\n      if (thisPageToVisit) {\n        const currentCount = loopCount;\n\n        if (loopCount % 500 === 0) {\n          // heapdump.writeSnapshot((err, filename) => {\n          //   if (err) console.log(err);\n          //   console.log('dump written to', filename);\n          // });\n\n          setTimeout(() => {\n            requestCount++;\n            requestPage(req, res, next, thisPageToVisit, currentCount);\n          }, 0);\n        } else {\n          requestCount++;\n          requestPage(req, res, next, thisPageToVisit, currentCount);\n        }\n      } else {\n        finishLoop(req, res, next);\n      }\n    }\n  } else {\n    finishLoop(req, res, next);\n  }\n}\n\n// Makes HTTP requests\nfunction requestPage(req, res, next, pageUrl, currentIndex) {\n  // Only request the page if you haven't visited it yet\n  const wasVisited = pagesToVisit.indexOf(pageUrl) < currentIndex;\n\n  if (pageUrl && !wasVisited) {\n    request(pageUrl, (error, response, body) => {\n      const headersMem = sizeof(response.headers);\n      const bodyMem = sizeof(body);\n      bandwidthUsed += headersMem + bodyMem;\n\n      const date = new Date();\n      console.log(currentIndex, date.toTimeString(), pageUrl);\n\n      if (error) {\n        console.log(pageUrl);\n        console.log(error);\n        changedPages[changedPages.length] = {url: pageUrl, status: 404};\n        loopBack(req, res, next);\n      } else {\n        const {redirects} = response.request._redirect;\n\n        if (redirects.length) {\n          const finalRedirect = redirects[redirects.length];\n          const finalDestination = finalRedirect &&\n            {url: finalRedirect.url, status: finalRedirect.statusCode};\n          const destIsInToVisit = finalDestination &&\n            pagesToVisit.findIndex(page => {\n              return finalDestination.url === page.url;\n            }) !== -1;\n\n          if (finalDestination && !destIsInToVisit) {\n            pagesToVisit[pagesToVisit.length] = finalDestination;\n          }\n        }\n\n        const redirectStatus = redirects[0] && redirects[0].statusCode;\n        const status = redirectStatus ?\n          redirectStatus :\n          response.statusCode;\n        const pageObj = {\n          url: pageUrl,\n          status\n        };\n        // If the page doesn't exist on Current URLs sheet,\n        // add it to 'changedPages'\n        const isInPagesToCrawl = req.pagesToCrawl.findIndex(page => {\n          return page.url === pageObj.url && page.status === pageObj.status;\n        }) !== -1;\n\n        if (!isInPagesToCrawl) {\n          pageObj.isChanged = !isInPagesToCrawl;\n          changedPages[changedPages.length] = pageObj;\n        }\n\n        // If the page is working & the body is html,\n        // collect links for other pages\n        if (!/40\\d/.test(status) && /<?\\/?html>/.test(body)) {\n          collectLinks(req, res, next, pageUrl, body);\n        } else {\n          loopBack(req, res, next);\n        }\n      }\n    });\n  } else {\n    loopBack(req, res, next);\n  }\n}\n\n// Scrape page for internal links to add to 'pagesToVisit'\nfunction collectLinks(req, res, next, pageUrl, body) {\n  const $ = cheerio.load(body);\n  const urlObj = new urlParse(pageUrl);\n  const domainBaseUrl = urlObj.hostname;\n  const domainRegExp = new RegExp(domainBaseUrl);\n  const protocol = urlObj.protocol;\n  // Collect URLs from link tags (adding current domain to relative links)\n  const linkTagsObj = $('a[href]');\n\n  for (let i = 0; i < linkTagsObj.length; i++) {\n    const link = linkTagsObj[i];\n    const linkRef = $(link).attr('href');\n    const isAbsolute = /http/i.test(linkRef);\n    const revisedLinkRef = linkRef === '/' ?\n      '' :\n      linkRef.replace(/\\?.*/, '').replace(/#.*/, '').replace(/\\/$/, '');\n    const linkUrl = isAbsolute ?\n      revisedLinkRef :\n      `${protocol}//${domainBaseUrl}${revisedLinkRef}`;\n    const linkObj = {\n      page_url: pageUrl,\n      link_url: linkUrl\n    };\n    const isCorrectLinkType = /^(?:\\/|http)/i.test(linkRef);\n    const isCorrectPageType =\n      !PAGE_REG_EXP.test(linkRef) && !TYPE_REG_EXP.test(linkRef);\n    const isCorrectDomain = isAbsolute ? domainRegExp.test(linkRef) : true;\n    const isInError = errorPages.indexOf(linkUrl) !== -1;\n    const isInBroken = brokenLinks.findIndex(link => {\n      return link.page_url === pageUrl && link.link_url === linkUrl;\n    }) !== -1;\n    const toVisitIndex = pagesToVisit.indexOf(linkUrl);\n    const isInToVisit = toVisitIndex !== -1;\n\n    if (/bspg/.test(linkRef)) {\n      console.log(`domain: ${isCorrectDomain}`, `inVisit: ${isInToVisit}`);\n    }\n\n    if (isCorrectLinkType && isCorrectPageType && isCorrectDomain) {\n      // If the URL is in 'errorPages' and not 'brokenLinks',\n      // add it to 'brokenLinks'\n      if (isInError && !isInBroken) {\n        brokenLinks[brokenLinks.length] = linkObj;\n      // Otherwise, add URL to 'pagesToVisit'\n      } else if (!isInToVisit) {\n        pagesToVisit[pagesToVisit.length] = linkUrl;\n      }\n    }\n  }\n\n  pageUrl = null;\n  body = null;\n  loopBack(req, res, next);\n}\n\nfunction loopBack(req, res, next) {\n  requestCount--;\n\n  if (requestCount === 0) {\n    console.log(`toCrawl: ${req.pagesToCrawl.length}`,\n      `changed: ${changedPages.length}`,\n      `toVisit: ${pagesToVisit.length}`);\n  }\n\n  if (requestCount === 0) {\n    if (req.pagesToCrawl.length + changedPages.length < pagesToVisit.length) {\n      continueLoop(req, res, next);\n    } else {\n      finishLoop(req, res, next);\n    }\n  }\n}\n\nfunction finishLoop(req, res, next) {\n  const revisedBandwidth = bandwidthUsed >= 1000000 ?\n    (Math.round(bandwidthUsed / 10000) / 100).toString() + 'MB' :\n    (Math.round(bandwidthUsed / 10) / 100).toString() + 'KB';\n  console.log(revisedBandwidth);\n  req.pagesCrawled = changedPages;\n  req.brokenLinks = brokenLinks;\n  next();\n}\n\nexport default checkUrls;\n"]}